<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="invoiceMapper">
	<resultMap type="Invoice" id="InvoiceMap">
		<result column="seq" property="seq"/>
		<result column="tsp" property="tsp"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<result column="write_date" property="writeDate"/>
		<result column="complete" property="complete"/>
	</resultMap>
	
	<resultMap type="InvoiceGbl" id="InvoiceGblMap">
		<result column="seq" property="seq" />
		<result column="invoice_list_seq" property="invoiceListSeq" />
		<result column="gbl_seq" property="gblSeq" />
		<result column="gbl_no" property="gblNo" />
		<result column="rank" property="rank" />
		<result column="name" property="name" />
		<result column="amount" property="amount" />
		<result column="complete" property="complete" />
	</resultMap>
	
	<select id="getSitListCount" resultType="Integer">
		SELECT
			COUNT(*)
		FROM
			invoice_sit_rate
		WHERE
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
	</select>
	
	<select id="getSitList" parameterType="Rate" resultType="Rate">
		SELECT
			seq, title, code, process, rate, write_year AS writeYear
		FROM
			invoice_sit_rate
		WHERE
			<choose>
				<when test="writeYear != null">
					write_year = #{writeYear}
				</when>
				<otherwise>
					write_year = DATE_FORMAT(SYSDATE(), '%Y')				
				</otherwise>
			</choose>			
		ORDER BY
			seq, process DESC
	</select>
	
	<select id="getSit" parameterType="Rate" resultType="Rate">
		SELECT
			seq, title, code, process, rate, write_year AS writeYear
		FROM
			invoice_sit_rate
		WHERE
			write_year = DATE_FORMAT(#{writeYear}, '%Y')
		AND
			title = #{title}
		AND
			process = #{process}
	</select>
	
	<select id="getOtherListCount" resultType="Integer">
		SELECT
			COUNT(*)
		FROM
			invoice_other_rate
		WHERE
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
	</select>
	
	<select id="getOtherList" parameterType="Rate" resultType="Rate">
		SELECT
			seq, title, code, process, rate, write_year AS writeYear
		FROM
			invoice_other_rate
		WHERE
			<choose>
				<when test="writeYear != null">
					write_year = #{writeYear}
				</when>
				<otherwise>
					write_year = DATE_FORMAT(SYSDATE(), '%Y')				
				</otherwise>
			</choose>			
		ORDER BY
			seq, process DESC		
	</select>	
	
	<select id="getOther" parameterType="Rate" resultType="Rate">
		SELECT
			seq, title, code, process, rate, write_year AS writeYear
		FROM
			invoice_other_rate
		WHERE
			write_year = DATE_FORMAT(#{writeYear}, '%Y')
		AND
			title = #{title}
		AND
			code = #{code}		
		AND
			process = #{process}
	</select>
	
	<select id="getBasicRateCheck" parameterType="Rate" resultType="Integer">
		SELECT
			count(*)
		FROM
			invoice_rate
		WHERE
			tsp = #{tsp}
		AND
			code = #{code}
		AND
			process = #{process}
		AND
			write_year = DATE_FORMAT(SYSDATE(), '%Y')			
		<if test="obType != null">
			AND
				ob_type = #{obType}
		</if>
	</select>
	
	<select id="getBasicRateList" parameterType="Rate" resultType="Rate">
		SELECT
			seq, tsp, code, rate, process, ob_type AS obType, write_year AS writeYear
		FROM
			invoice_rate
		WHERE
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
		AND
			container_rate is null
		ORDER BY
			process, tsp, code
	</select>
	
	<select id="getBasicRate" parameterType="Rate" resultType="Rate">
		SELECT
			seq, tsp, code, rate, process, ob_type AS obType, write_year AS writeYear
		FROM
			invoice_rate
		WHERE
			write_year = DATE_FORMAT(#{writeYear}, '%Y')
		AND
			tsp = #{tsp}
		AND
			code = #{code}
		AND
			process = #{process}			
		<if test="obType != null">
			AND
				ob_type = #{obType}
		</if>					
	</select>
	
	<select id="getContainerCheck" parameterType="Rate" resultType="Integer">
		SELECT
			count(*)
		FROM
			invoice_rate
		WHERE
			tsp = #{tsp}
		AND
			container_status = #{containerStatus}
		AND
			write_year = DATE_FORMAT(SYSDATE(), '%Y')	
	</select>
	
	<select id="getEtcCheck" parameterType="Rate" resultType="Integer">
		SELECT
			count(*)
		FROM
			invoice_etc_rate
		WHERE
			title = #{title}
		AND
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
	</select>
	
	<select id="etcList" parameterType="Rate" resultType="Rate">
		SELECT
			seq, title, rate, write_year
		FROM
			invoice_etc_rate
		WHERE
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
	</select>
	
	<select id="getEtc" parameterType="Map" resultType="Rate">
		SELECT
			seq, title, rate, write_year
		FROM
			invoice_etc_rate
		WHERE
			write_year = DATE_FORMAT(#{pud}, '%Y')
		AND
			title = #{title}
			
	</select>
	
	<select id="getContainerRateList" parameterType="Rate" resultType="Rate">
		SELECT
			seq, tsp, container_status AS containerStatus, container_rate AS containerRate, write_year AS writeYear
		FROM
			invoice_rate
		WHERE
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
		AND
			container_rate is not null
		ORDER BY
			process, tsp, code
	</select>	
	
	<select id="getContainerRate" parameterType="Rate" resultType="Rate">	
		SELECT
			seq, tsp, container_status AS containerStatus, container_rate AS containerRate, write_year AS writeYear
		FROM
			invoice_rate
		WHERE
			write_year = DATE_FORMAT(#{writeYear}, '%Y')
		AND
			tsp = #{tsp}
		AND
			container_status = #{containerStatus}
	</select>
	
	<select id="getInvoiceListCount" parameterType="InvoiceFilter" resultType="Integer">
		SELECT
			count(*)
		FROM
			invoice_list
	</select>
	
	<select id="getInvoiceList" parameterType="InvoiceFilter" resultMap="InvoiceMap">
		SELECT 
			*
		FROM	
		(
			SELECT
				(@rownum := @rownum + 1) AS rownum,
				i.seq, i.tsp, i.start_date, i.end_date, i.write_date, i.complete
			FROM
				invoice_list i, (SELECT @rownum := 0) r
			ORDER BY
				i.seq
		) il
		WHERE rownum BETWEEN #{pagination.itemSeqBegin} AND #{pagination.itemSeqEnd}
	</select>
	
	<select id="getSettingGblList" parameterType="Invoice" resultMap="InvoiceGblMap">		
		SELECT
			g.seq AS gbl_seq, g.no AS gbl_no, g.rank, g.customer_name AS name 
		FROM
			gbl g, gbl_status gs
		WHERE
			g.scac = #{tsp}
		AND
			g.pud BETWEEN #{startDate} and #{endDate}
		AND
			g.no = gs.gbl_no
		AND
			gs.gbl_invoice = false
		AND
			gs.gbl_truckmanifast = true
		AND
			gs.gbl_bookingList = true		
	</select>
	
	<select id="getInvoice" parameterType="Invoice" resultMap="InvoiceMap">
		SELECT
			seq, tsp, start_date, end_date, write_date, complete
		FROM
			invoice_list
		WHERE
			seq = #{seq}
	</select>
	
	<select id="getInvoiceGblList" parameterType="Integer" resultMap="InvoiceGblMap">
		SELECT
			seq, invoice_list_seq, gbl_seq, gbl_no, rank, name, amount, complete
		FROM
			invoice_gbl
		WHERE
			invoice_list_seq = #{value}
	</select>
	
	<select id="getInvoiceGblListbyInvoice" parameterType="Invoice" resultMap="InvoiceGblMap">
		SELECT
			seq, invoice_list_seq, gbl_seq, gbl_no, rank, name, amount, complete
		FROM
			invoice_gbl
		WHERE
			invoice_list_seq = #{seq}
	</select>
	
	<select id="getInvoiceGblContentCount" parameterType="Integer" resultType="Integer">
		SELECT
			count(*)
		FROM
			invoice_gbl_content
		WHERE
			invoice_gbl_seq = #{value}
	</select>
	
	<select id="getTotalWeightCertificate" parameterType="Integer" resultType="WeightCertificate">		
        SELECT
        	seq,
        	piece,
        	type,
        	status,
        	SUM(gross) gross,
        	SUM(tare) tare,
        	SUM(net) net,
        	remark,
        	gbl_seq AS gblSeq,
        	DATE AS DATE,
        	truck_check AS truckCheck,
        	truck_seq AS truckSeq
        FROM
        	weight_certificate
        WHERE
			gbl_seq = #{value}
		GROUP BY
			gbl_seq
	</select>
	
	<select id="checkInvoiceContent" parameterType="InvoiceGblContent" resultType="Integer">
		SELECT
			seq
		FROM
			invoice_gbl_content
		WHERE
			invoice_gbl_seq = #{invoiceGblSeq}
		AND
			charging_item = #{chargingItem}
	</select>
	
	<insert id="insertNewYearSIT" parameterType="Map">
		INSERT INTO
			invoice_sit_rate
			(
				title, code, process, write_year
			)
		VALUES
			<foreach collection="rateList" item="rate" separator=",">
				(#{rate.title}, #{rate.code}, #{rate.process}, DATE_FORMAT(SYSDATE(), '%Y'))
			</foreach>
	</insert>
	
	<insert id="insertNewYearOther" parameterType="Map">
		INSERT INTO
			invoice_other_rate
			(
				title, code, process, write_year
			)
		VALUES
			<foreach collection="rateList" item="rate" separator=",">
				(#{rate.title}, #{rate.code}, #{rate.process}, DATE_FORMAT(SYSDATE(), '%Y'))
			</foreach>
	</insert>
	
	<insert id="basicInsert" parameterType="Rate">
		INSERT INTO
			invoice_rate
			(
				tsp, code, rate, process, write_year
				<if test="obType != null">
					, ob_type
				</if>
			)
		VALUES
			(
				#{tsp}, #{code}, #{rate}, #{process}, DATE_FORMAT(SYSDATE(), '%Y')
				
				<if test="obType != null">
					, #{obType}
				</if>
			)
	</insert>
	
	<insert id="etcInsert" parameterType="Rate">
		INSERT INTO
			invoice_etc_rate
			(
				title, rate, write_year
			)
		VALUES
			(
				#{title}, #{rate}, DATE_FORMAT(SYSDATE(), '%Y')
			)
	</insert>
	
	<insert id="containerInsert" parameterType="Rate">
		INSERT INTO
			invoice_rate
			(
				tsp, container_rate, container_status, write_year
			)
		VALUES
			(
				#{tsp}, #{containerRate}, #{containerStatus}, DATE_FORMAT(SYSDATE(), '%Y')
			)
	</insert>
	
	<insert id="insertInvoice" parameterType="Invoice">
		INSERT INTO
			invoice_list
			(
				tsp, start_date, end_date, write_date, complete, process
			)
		VALUES
			(
				#{tsp}, #{startDate}, #{endDate}, SYSDATE(), 0, #{process}
			)
		<selectKey keyProperty="seq" resultType="Integer">
			SELECT LAST_INSERT_ID()  
		</selectKey>
	</insert>
	
	<insert id="insertInvoiceGbl" parameterType="InvoiceGbl">
		INSERT INTO
			invoice_gbl
			(
				invoice_list_seq, gbl_seq, gbl_no, rank, name, amount, complete
			)
		VALUES
			(
				#{invoiceListSeq}, #{gblSeq}, #{gblNo}, #{rank}, #{name}, 0, 0
			)
	</insert>
	
	<insert id="insertInvoiceGblContent" parameterType="InvoiceGblContent">
		INSERT INTO
			invoice_gbl_content
			(
				invoice_gbl_seq, charging_item, quantity, amount
			)
		VALUES
			(
				#{invoiceGblSeq}, #{chargingItem}, #{quantity}, #{amount}
			)
	</insert>
	
	<update id="basicUpdate" parameterType="Rate">
		UPDATE
			invoice_rate
		SET
			rate = #{rate}
		WHERE
			tsp = #{tsp}
		AND
			code = #{code}
		AND
			process = #{process}
		AND
			write_year = DATE_FORMAT(SYSDATE(), '%Y')
		<if test="obType != null">
			AND
				ob_type = #{obType}
		</if>		
	</update>
	
	<update id="etcRateUpate" parameterType="Rate">
		UPDATE
			invoice_etc_rate
		SET
			rate = #{rate}
		WHERE
			title = #{title}
		AND
			write_year = DATE_FORMAT(SYSDATE(), 'Y%')
	</update>
	
	<update id="containerUpdate" parameterType="Rate">
		UPDATE
			invoice_rate
		SET
			container_rate = #{containerRate}
		WHERE
			tsp = #{tsp}
		AND
			container_status = #{containerStatus}		
	</update>
	
	<update id="sitUpdate" parameterType="Rate">
		UPDATE
			invoice_sit_rate
		SET
			rate = #{rate}
		WHERE
			seq = #{seq}
	</update>
	
	<update id="otherUpdate" parameterType="Rate">
		UPDATE
			invoice_other_rate
		SET
			rate = #{rate}
		WHERE
			seq = #{seq}
	</update>
	
	<update id="updateInvoiceGblContent" parameterType="InvoiceGblContent">
		UPDATE
			invoice_gbl_content
		SET
			amount = #{amount}
		WHERE
			seq = #{seq}
	</update>
	
	<update id="updateInvoiceGbl" parameterType="InvoiceGbl">
		UPDATE
			invoice_gbl
		SET
			amount = #{amount},
			complete = #{complete}
		WHERE
			seq = #{seq}
	</update>
	
	<update id="checkAndUpdateInvoice" parameterType="Integer">
		UPDATE
			invoice_list
		SET
			complete = true
		WHERE
			seq = (
					SELECT * FROM
					(
						SELECT seq FROM invoice_list i
						WHERE seq = '52' 
						AND	
						(	SELECT
								COUNT(*)
							FROM
								invoice_gbl
							WHERE
								invoice_list_seq = i.seq
						) = 
						(
							SELECT 
								COUNT(*)
							FROM
								invoice_gbl
							WHERE
								invoice_list_seq = i.seq
							AND
								complete = TRUE
						) 
					) AS ck
				)			
	</update>
	
	<delete id="deleteInvoice" parameterType="Invoice">
		DELETE FROM
			invoice_list
		WHERE
			seq = #{seq}
	</delete>
</mapper>